# Описание ER-модели

## Сущности

### User
Пользователь системы

| Атрибут       | Тип        | Описание                    |
|---------------|------------|-----------------------------|
| id            | PK, UUID   | Уникальный идентификатор    |
| email         | VARCHAR    | Логин / почта               |
| password_hash | VARCHAR    | Хэш пароля                  |
| name          | VARCHAR    | Отображаемое имя            |
| created_at    | TIMESTAMP  | Дата регистрации            |
| updated_at    | TIMESTAMP  | Дата последнего обновления  |

---

### Subscription
Подписка пользователя на план SaaS (привязана к пользователю, не к группе).

| Атрибут    | Тип       | Описание                         |
|------------|-----------|----------------------------------|
| id         | PK, UUID  | Уникальный идентификатор         |
| user_id    | FK → User | Пользователь                     |
| plan       | VARCHAR   | План (free, basic, premium)      |
| started_at | TIMESTAMP | Начало подписки                  |
| expires_at | TIMESTAMP | Окончание подписки               |

---

### FamilyGroup
Группа пользователей, совместно имеющих доступ к одним и тем же домам и устройствам.

| Атрибут    | Тип       | Описание                              |
|------------|-----------|---------------------------------------|
| id         | PK, UUID  | Уникальный идентификатор              |
| name       | VARCHAR   | Название группы (например, «Семья»)   |
| owner_id   | FK → User | Создатель группы (владелец)           |
| created_at | TIMESTAMP | Дата создания                         |
| updated_at | TIMESTAMP | Дата последнего обновления            |

---

### FamilyGroupMember
Связь «многие ко многим» между пользователями и группами. Определяет, кто в какой группе состоит и с какой ролью.

| Атрибут   | Тип            | Описание                                      |
|-----------|-----------------|-----------------------------------------------|
| group_id  | PK, FK → FamilyGroup | Идентификатор группы                    |
| user_id   | PK, FK → User   | Идентификатор пользователя                    |
| role      | VARCHAR         | Роль: owner, admin, member                    |
| joined_at | TIMESTAMP       | Дата присоединения к группе                   |

**Связи:**
- Один пользователь может состоять в нескольких семейных группах.
- В одной группе может быть несколько участников.
- Все участники группы получают доступ ко всем домам этой группы (и ко всем устройствам и сценариям этих домов).

---

### House
Дом или квартира принадлежит **семейной группе**

| Атрибут          | Тип              | Описание                         |
|------------------|-------------------|----------------------------------|
| id               | PK, UUID          | Уникальный идентификатор         |
| family_group_id  | FK → FamilyGroup  | Группа, которой принадлежит дом   |
| name             | VARCHAR           | Название (например, «Квартира»)  |
| address          | VARCHAR           | Адрес                            |
| timezone         | VARCHAR           | Часовой пояс                     |
| created_at       | TIMESTAMP         | Дата создания                    |
| updated_at       | TIMESTAMP         | Дата обновления                  |

**Связи:**
- Дом принадлежит одной семейной группе.
- Все члены этой группы видят дом и все его устройства и сценарии.

---

### DeviceType
Справочник типов устройств (отопление, свет, ворота, датчик, камера и т.д.) и протокол связи.

| Атрибут     | Тип      | Описание                                    |
|-------------|----------|---------------------------------------------|
| id          | PK, UUID | Уникальный идентификатор                    |
| name        | VARCHAR  | Название типа                               |
| category    | VARCHAR  | Категория: heating, lighting, gate, sensor, camera, other |
| protocol    | VARCHAR  | Протокол: MQTT, HTTP, Zigbee, ZWave, CoAP   |
| description | TEXT     | Описание                                    |
| is_partner  | BOOLEAN  | Устройство партнёра                         |

---

### Device
Конкретное зарегистрированное устройство в доме.

| Атрибут         | Тип             | Описание                          |
|-----------------|------------------|-----------------------------------|
| id              | PK, UUID         | Уникальный идентификатор          |
| house_id        | FK → House       | Дом, в котором находится устройство |
| device_type_id  | FK → DeviceType  | Тип устройства                    |
| serial_number   | VARCHAR          | Серийный номер                    |
| name            | VARCHAR          | Отображаемое имя                  |
| status          | VARCHAR          | online, offline, error            |
| location        | VARCHAR          | Местоположение в доме             |
| settings        | JSONB            | Настройки устройства              |
| registered_at   | TIMESTAMP        | Дата регистрации                  |
| created_at      | TIMESTAMP        | Дата создания                     |
| updated_at      | TIMESTAMP        | Дата обновления                   |

---

### TelemetryData
Запись телеметрии с устройства (временной ряд).

| Атрибут    | Тип            | Описание                |
|------------|-----------------|-------------------------|
| id         | PK, BIGSERIAL   | Уникальный идентификатор |
| device_id  | FK → Device     | Устройство              |
| metric     | VARCHAR         | Имя метрики             |
| value      | NUMERIC/JSONB   | Значение                |
| unit       | VARCHAR         | Единица измерения       |
| recorded_at| TIMESTAMP       | Время замера            |

---

### Scenario
Сценарий привязан к дому и его видят и редактируют все члены группы, которой принадлежит дом.

| Атрибут    | Тип          | Описание                    |
|------------|--------------|-----------------------------|
| id         | PK, UUID     | Уникальный идентификатор    |
| house_id   | FK → House   | Дом                         |
| name       | VARCHAR      | Название сценария           |
| description| TEXT         | Описание                    |
| is_enabled | BOOLEAN      | Включён ли сценарий         |
| triggers   | JSONB        | Триггеры (события, расписание) |
| conditions | JSONB        | Условия                     |
| actions    | JSONB        | Действия                    |
| created_at | TIMESTAMP    | Дата создания               |
| updated_at | TIMESTAMP    | Дата обновления             |

---

## Связи между сущностями

| Связь | Тип   | Описание |
|-------|--------|----------|
| User — Subscription | 1 : N | У пользователя может быть несколько подписок (текущая и история). |
| User — FamilyGroup (owner) | 1 : N | Пользователь может быть владельцем нескольких групп. |
| User — FamilyGroupMember | 1 : N | Пользователь может участвовать в нескольких группах. |
| FamilyGroup — FamilyGroupMember | 1 : N | В группе несколько участников. |
| FamilyGroup — House | 1 : N | У группы несколько домов; дом принадлежит одной группе. |
| House — Device | 1 : N | В доме несколько устройств; устройство в одном доме. |
| DeviceType — Device | 1 : N | Один тип — много устройств; у устройства один тип. |
| Device — TelemetryData | 1 : N | Одно устройство — много записей телеметрии. |
| House — Scenario | 1 : N | У дома много сценариев; сценарий привязан к одному дому. |
